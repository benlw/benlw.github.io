<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‹å­æ»¡ç®—æœ¯å°è¯¾å ‚</title>
    <style>
        :root {
            --primary: #4A90E2;
            --accent: #FF6B6B;
            --success: #2ECC71;
            --bg: #F0F4F8;
            --card-bg: #FFFFFF;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Rounded Mplus 1c', sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        [hidden] {
            display: none !important;
        }

        /* é¡¶éƒ¨å¯¼èˆªä¸æ¨¡å¼åˆ‡æ¢ */
        header {
            width: 100%;
            padding: calc(12px + env(safe-area-inset-top)) 12px 12px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
        }

        .nav-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-width: 920px;
        }

        .mode-btn {
            padding: 12px 18px;
            border: 2px solid var(--primary);
            border-radius: 18px;
            background: transparent;
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 132px;
            min-height: 44px;
            font-size: 0.95rem;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 720px;
            width: min(92%, 720px);
            background: var(--card-bg);
            margin-top: 18px;
            padding: 20px 18px 24px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            text-align: center;
        }

        /* å¯è§†åŒ–åŒºåŸŸ */
        .visual-stage {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin: 20px 0;
            min-height: 170px;
            width: 100%;
            overflow: hidden;
        }

        .visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            width: 100%;
        }

        @media (min-width: 560px) {
            .visual { flex-wrap: nowrap; }
        }

        .ten-frame-wrapper {
            position: relative;
        }

        .ten-frame {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(2, 1fr);
            width: 160px;
            height: 70px;
            border: 3px solid #333;
            background: #fff;
            padding: 5px;
            gap: 5px;
            border-radius: 8px;
        }

        .cell {
            border: 1px solid #eee;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dot {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            transition: transform 0.8s ease-in-out, opacity 0.5s;
            z-index: 10;
        }

        .dot.small {
            width: 12px;
            height: 12px;
        }

        .dot.blue { background-color: var(--primary); box-shadow: 1px 1px 0 #2c5e96; }
        .dot.red { background-color: var(--accent); box-shadow: 1px 1px 0 #a83232; }
        .dot.faded { opacity: 0.2; }

        .dot.pulse {
            animation: dotPulse 0.6s ease-in-out 2;
        }

        @keyframes dotPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.0); }
            50% { box-shadow: 0 0 0 6px rgba(255, 107, 107, 0.3); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.0); }
        }

        .frame-glow {
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.25);
            border-color: var(--accent);
        }

        .operator-sign { font-size: 2rem; color: #888; font-weight: bold; }

        /* è¿›é˜¶ï¼šåä½æ£’ + ä¸ªä½æ¡† */
        .base10-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .tens-rack {
            display: flex;
            gap: 6px;
            align-items: flex-end;
            height: 70px;
        }

        .ten-rod {
            width: 16px;
            height: 60px;
            border-radius: 6px;
            background: var(--primary);
            box-shadow: inset -2px -2px 0 rgba(0,0,0,0.15);
        }

        .ten-rod.red {
            background: var(--accent);
        }

        .ten-rod.pop {
            animation: rodPop 0.5s ease-out;
        }

        @keyframes rodPop {
            0% { transform: translateY(10px) scale(0.7); opacity: 0.2; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }

        .ones-frame {
            position: relative;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(4, 1fr);
            width: 160px;
            height: 120px;
            border: 2px solid #333;
            padding: 4px;
            gap: 4px;
            border-radius: 8px;
            background: #fff;
        }

        .ones-frame::after {
            content: '';
            position: absolute;
            left: 6px;
            right: 6px;
            top: 50%;
            height: 2px;
            background: #e6e6e6;
        }

        .ones-cell {
            border: 1px solid #eee;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ä¹˜é™¤æ³•é˜µåˆ— */
        .array-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            width: 100%;
        }

        .array-row {
            display: flex;
            gap: 8px;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .array-row.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* ç®—å¼ä¸è¾“å…¥ */
        .math-equation {
            font-size: 3rem;
            font-weight: 800;
            color: #2c3e50;
            margin: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .answer-input {
            width: 140px;
            font-size: 2.5rem;
            text-align: center;
            border: 3px solid #ddd;
            border-radius: 12px;
            outline: none;
            color: var(--primary);
            background: #fff;
            caret-color: transparent;
        }

        .answer-input:focus { border-color: var(--primary); }
        .answer-input.correct { border-color: var(--success); background-color: #e8f8f5; }
        .answer-input.wrong { border-color: var(--accent); background-color: #fdedec; }

        /* æŒ‰é’®ç»„ */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px;
            font-size: 1.1rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }

        .btn:active { transform: scale(0.96); }

        .btn-check { background-color: var(--success); color: white; grid-column: span 2; font-size: 1.3rem; }
        .btn-hint { background-color: #F1C40F; color: #333; }
        .btn-next { background-color: var(--primary); color: white; }

        .message { height: 30px; margin-top: 10px; font-weight: bold; color: #555; }

        /* å†…ç½®æ•°å­—é”®ç›˜ */
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 22px auto 0;
            width: 100%;
            max-width: 360px;
        }

        .key-btn {
            padding: 12px 10px;
            font-size: 1.4rem;
            border-radius: 12px;
            border: 2px solid #e1e8f0;
            background: #f7f9fc;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
        }

        .key-btn:active { transform: scale(0.97); }

        .key-btn.key-clear { background: #ffe9d6; border-color: #ffd4ad; }
        .key-btn.key-back { background: #ffe0e0; border-color: #ffc2c2; }
        .key-btn.key-submit {
            background: var(--success);
            color: white;
            border-color: #22b765;
            grid-column: span 3;
            font-size: 1.2rem;
        }

        @media (max-width: 480px) {
            .math-equation { font-size: 2.4rem; }
            .answer-input { width: 80px; font-size: 2.2rem; }
        }

        @media (max-width: 540px), (max-height: 760px) {
            header { padding: calc(8px + env(safe-area-inset-top)) 10px 8px; }
            .nav-container { gap: 8px; }
            .mode-btn {
                padding: 8px 10px;
                min-width: 96px;
                font-size: 0.82rem;
                border-radius: 16px;
                min-height: 42px;
            }

            .container { margin-top: 12px; padding: 14px 12px 16px; width: min(94%, 720px); }
            .visual-stage { margin: 12px 0; min-height: 140px; }
            .visual { gap: 12px; }
            .operator-sign { font-size: 1.6rem; }

            .ten-frame { width: 140px; height: 62px; }
            .dot { width: 20px; height: 20px; }
            .dot.small { width: 11px; height: 11px; }

            .tens-rack { height: 60px; }
            .ten-rod { width: 14px; height: 52px; }
            .ones-frame { width: 150px; height: 104px; }

            .math-equation { font-size: 2.1rem; }
            .answer-input { width: 72px; font-size: 2rem; }

            .controls { gap: 10px; margin-top: 14px; }
            .btn { padding: 12px; font-size: 1rem; }

            .keypad { gap: 8px; margin-top: 14px; max-width: 320px; }
            .key-btn { padding: 10px 8px; font-size: 1.2rem; }
            .key-btn.key-submit { font-size: 1.1rem; }
            .message { height: 24px; margin-top: 6px; }
        }
    </style>
</head>
<body>

<header>
    <div class="nav-container">
        <button class="mode-btn active" data-mode="add">â• 20å†…åŠ æ³•</button>
        <button class="mode-btn" data-mode="sub">â– 20å†…å‡æ³•</button>
        <button class="mode-btn" data-mode="add-adv">ğŸš€ è¿›é˜¶åŠ æ³•</button>
        <button class="mode-btn" data-mode="sub-adv">ğŸš€ è¿›é˜¶å‡æ³•</button>
        <button class="mode-btn" data-mode="mul">âœ–ï¸ ä¹˜æ³•</button>
        <button class="mode-btn" data-mode="div">â— é™¤æ³•</button>
    </div>
    <div class="nav-container" style="margin-top:15px; border-top: 2px dashed #eee; padding-top:15px;">
        <span style="width:100%; text-align:center; color:#888; font-size:0.9rem; margin-bottom:5px;">ğŸ§© ç›Šæ™ºå¹¿åœº</span>
        <a href="game.html" class="mode-btn" style="text-decoration:none;display:flex;align-items:center;justify-content:center;color:#e67e22;border-color:#e67e22;">ğŸ® æ¶ˆæ¶ˆä¹</a>
        <a href="connect4.html" class="mode-btn" style="text-decoration:none;display:flex;align-items:center;justify-content:center;color:#e74c3c;border-color:#e74c3c;">ğŸ”´ğŸŸ¡ å››å­æ£‹</a>
    </div>
</header>

<div class="container">
    <div class="message" id="msgArea">å‡†å¤‡å¥½äº†å—ï¼Ÿ</div>

    <div class="visual-stage">
        <div class="visual visual-tenframes" data-visual="tenframes">
            <div class="ten-frame-wrapper">
                <div class="ten-frame" id="frame1"></div>
            </div>

            <div class="operator-sign" id="visualOp">+</div>

            <div class="ten-frame-wrapper">
                <div class="ten-frame" id="frame2"></div>
            </div>
        </div>

        <div class="visual visual-base10" data-visual="base10" hidden>
            <div class="base10-group">
                <div class="tens-rack" id="tens1"></div>
                <div class="ones-frame" id="ones1"></div>
            </div>

            <div class="operator-sign" id="visualOpBase10">+</div>

            <div class="base10-group">
                <div class="tens-rack" id="tens2"></div>
                <div class="ones-frame" id="ones2"></div>
            </div>
        </div>

        <div class="visual visual-array" data-visual="array" hidden>
            <div class="array-grid" id="arrayGrid"></div>
        </div>
    </div>

    <div class="math-equation">
        <span id="num1">0</span>
        <span id="opSymbol">+</span>
        <span id="num2">0</span>
        <span>=</span>
        <input type="text" id="answerInput" class="answer-input" placeholder="?" inputmode="none" autocomplete="off" readonly>
    </div>

    <div class="controls">
        <button class="btn btn-hint" id="hintBtn">ğŸ’¡ æ¼”ç¤ºæ€ä¹ˆç®—</button>
        <button class="btn btn-next" id="nextBtn">ğŸ² ä¸‹ä¸€é¢˜</button>
    </div>

    <div class="keypad" id="keypad" aria-label="æ•°å­—é”®ç›˜">
        <button class="key-btn" data-key="1">1</button>
        <button class="key-btn" data-key="2">2</button>
        <button class="key-btn" data-key="3">3</button>
        <button class="key-btn" data-key="4">4</button>
        <button class="key-btn" data-key="5">5</button>
        <button class="key-btn" data-key="6">6</button>
        <button class="key-btn" data-key="7">7</button>
        <button class="key-btn" data-key="8">8</button>
        <button class="key-btn" data-key="9">9</button>
        <button class="key-btn key-clear" data-key="clear">æ¸…ç©º</button>
        <button class="key-btn" data-key="0">0</button>
        <button class="key-btn key-back" data-key="back">âŒ«</button>
        <button class="key-btn key-submit" data-key="submit">æäº¤</button>
    </div>
</div>

<script>
    const state = {
        mode: 'add',
        n1: 0,
        n2: 0,
        ans: 0,
        isAnimating: false
    };

    function playSound(type) {
        if (type === 'correct') {
            new Audio('bingo.mp3').play().catch(e => console.error('Play error:', e));
        } else if (type === 'wrong') {
            new Audio('failure.mp3').play().catch(e => console.error('Play error:', e));
        }
    }

    const msgEl = document.getElementById('msgArea');
    const inputEl = document.getElementById('answerInput');
    const num1El = document.getElementById('num1');
    const num2El = document.getElementById('num2');
    const opSymbolEl = document.getElementById('opSymbol');
    const visualOpEl = document.getElementById('visualOp');
    const visualOpBase10El = document.getElementById('visualOpBase10');
    const frame1El = document.getElementById('frame1');
    const frame2El = document.getElementById('frame2');
    const tens1El = document.getElementById('tens1');
    const tens2El = document.getElementById('tens2');
    const ones1El = document.getElementById('ones1');
    const ones2El = document.getElementById('ones2');
    const arrayGridEl = document.getElementById('arrayGrid');
    const keypadEl = document.getElementById('keypad');
    const hintBtn = document.getElementById('hintBtn');
    const nextBtn = document.getElementById('nextBtn');

    const visuals = {
        tenframes: document.querySelector('[data-visual="tenframes"]'),
        base10: document.querySelector('[data-visual="base10"]'),
        array: document.querySelector('[data-visual="array"]')
    };

    const ONES_CELL_COUNT = 20;

    function setMessage(text, color) {
        msgEl.textContent = text || '';
        msgEl.style.color = color || '#555';
    }

    function setMode(mode) {
        state.mode = mode;
        setActiveModeButton(mode);
        generateProblem();
    }

    function setActiveModeButton(mode) {
        document.querySelectorAll('.mode-btn').forEach((btn) => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
    }

    function getVisualKey(mode) {
        if (mode === 'add' || mode === 'sub') return 'tenframes';
        if (mode === 'add-adv' || mode === 'sub-adv') return 'base10';
        return 'array';
    }

    function setVisualByMode(mode) {
        const target = getVisualKey(mode);
        Object.keys(visuals).forEach((key) => {
            visuals[key].hidden = key !== target;
        });
    }

    function getOperator(mode) {
        if (mode === 'add' || mode === 'add-adv') return '+';
        if (mode === 'sub' || mode === 'sub-adv') return '-';
        if (mode === 'mul') return 'Ã—';
        if (mode === 'div') return 'Ã·';
        return '+';
    }

    function updateEquation() {
        num1El.textContent = state.n1;
        num2El.textContent = state.n2;
        opSymbolEl.textContent = getOperator(state.mode);

        if (state.mode === 'add') {
            visualOpEl.textContent = '+';
        } else {
            visualOpEl.textContent = '';
        }

        if (state.mode === 'add-adv') {
            visualOpBase10El.textContent = '+';
        } else if (state.mode === 'sub-adv') {
            visualOpBase10El.textContent = '-';
        } else {
            visualOpBase10El.textContent = '';
        }
    }

    function generateProblem() {
        state.isAnimating = false;
        resetUI();

        if (state.mode === 'add') {
            generateAddWithin20();
        } else if (state.mode === 'sub') {
            generateSubWithin20();
        } else if (state.mode === 'add-adv') {
            generateAdvAdd();
        } else if (state.mode === 'sub-adv') {
            generateAdvSub();
        } else if (state.mode === 'mul') {
            generateMul();
        } else if (state.mode === 'div') {
            generateDiv();
        }

        updateEquation();
        setVisualByMode(state.mode);
        renderCurrent();
    }

    function generateAddWithin20() {
        let n1 = rand(6, 9);
        let n2 = rand(11 - n1, 9);
        if (Math.random() > 0.7) n2 = rand(1, 10 - n1);
        state.n1 = n1;
        state.n2 = n2;
        state.ans = n1 + n2;
    }

    function generateSubWithin20() {
        let n1;
        let n2;
        if (Math.random() < 0.7) {
            n1 = rand(11, 19);
            while (n1 % 10 === 9) n1 = rand(11, 19);
            const ones = n1 % 10;
            n2 = rand(ones + 1, 9);
        } else {
            n1 = rand(6, 19);
            while (n1 % 10 === 0) n1 = rand(6, 19);
            const ones = n1 % 10;
            n2 = rand(1, Math.min(9, ones));
        }
        state.n1 = n1;
        state.n2 = n2;
        state.ans = n1 - n2;
    }

    function generateAdvAdd() {
        let n1;
        let n2;
        const wantCarry = Math.random() < 0.7;
        if (wantCarry) {
            for (let i = 0; i < 20; i++) {
                n1 = rand(20, 45);
                const ones = n1 % 10;
                const needed = 10 - ones;
                const maxAdd = Math.min(9, 50 - n1);
                if (needed >= 1 && needed <= maxAdd) {
                    n2 = rand(needed, maxAdd);
                    break;
                }
            }
        }
        if (!Number.isInteger(n2)) {
            n1 = rand(20, 49);
            const maxAdd = Math.min(9, 50 - n1);
            n2 = rand(1, Math.max(1, maxAdd));
        }
        state.n1 = n1;
        state.n2 = n2;
        state.ans = n1 + n2;
    }

    function generateAdvSub() {
        let n1 = rand(29, 50);
        let ones = n1 % 10;
        let n2;
        const wantBorrow = Math.random() < 0.7;
        if (wantBorrow) {
            for (let i = 0; i < 10 && ones === 9; i++) {
                n1 = rand(29, 50);
                ones = n1 % 10;
            }
            if (ones === 9) {
                n1 = 48;
                ones = 8;
            }
            n2 = rand(ones + 1, 9);
        } else {
            while (ones === 0) {
                n1 = rand(29, 50);
                ones = n1 % 10;
            }
            const maxSub = Math.min(9, ones);
            n2 = rand(1, maxSub);
        }
        state.n1 = n1;
        state.n2 = n2;
        state.ans = n1 - n2;
    }

    function generateMul() {
        const n1 = rand(2, 5);
        const n2 = rand(2, 5);
        state.n1 = n1;
        state.n2 = n2;
        state.ans = n1 * n2;
    }

    function generateDiv() {
        const divisor = rand(2, 5);
        const quotient = rand(2, 5);
        state.n1 = divisor * quotient;
        state.n2 = divisor;
        state.ans = quotient;
    }

    function renderCurrent() {
        const visualKey = getVisualKey(state.mode);
        if (visualKey === 'tenframes') renderTenFrames();
        if (visualKey === 'base10') renderBase10();
        if (visualKey === 'array') renderArray(true);
    }

    function renderTenFrames() {
        if (state.mode === 'add') {
            fillGrid('frame1', state.n1, 'blue');
            fillGrid('frame2', state.n2, 'red');
            return;
        }

        const frame1Count = Math.min(state.n1, 10);
        const frame2Count = Math.max(state.n1 - 10, 0);
        fillGrid('frame1', frame1Count, 'blue');
        fillGrid('frame2', frame2Count, 'blue');
    }

    function renderBase10() {
        renderBase10Group(tens1El, ones1El, state.n1, 'blue', 'ones1');
        renderBase10Group(tens2El, ones2El, state.n2, 'red', 'ones2');
    }

    function renderBase10Group(tensEl, onesEl, number, color, prefix) {
        const tens = Math.floor(number / 10);
        const ones = number % 10;
        fillTensRack(tensEl, tens, color);
        fillOnesFrame(onesEl, ones, color, prefix);
    }

    function renderArray(showAll) {
        arrayGridEl.innerHTML = '';
        const rows = state.mode === 'mul' ? state.n1 : state.ans;
        const cols = state.n2;
        for (let r = 0; r < rows; r++) {
            const row = document.createElement('div');
            row.className = `array-row${showAll ? ' show' : ''}`;
            row.id = `array-r${r}`;
            for (let c = 0; c < cols; c++) {
                const dot = document.createElement('div');
                dot.className = 'dot blue';
                row.appendChild(dot);
            }
            arrayGridEl.appendChild(row);
        }
    }

    function fillGrid(id, count, color) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        for (let i = 0; i < 10; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `${id}-c${i}`;
            if (i < count) {
                const dot = document.createElement('div');
                dot.className = `dot ${color}`;
                dot.id = `${id}-d${i}`;
                cell.appendChild(dot);
            }
            el.appendChild(cell);
        }
    }

    function fillTensRack(el, count, color) {
        el.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const rod = document.createElement('div');
            rod.className = `ten-rod${color === 'red' ? ' red' : ''}`;
            rod.id = `${el.id}-r${i}`;
            el.appendChild(rod);
        }
    }

    function fillOnesFrame(el, count, color, prefix) {
        el.innerHTML = '';
        for (let i = 0; i < ONES_CELL_COUNT; i++) {
            const cell = document.createElement('div');
            cell.className = 'ones-cell';
            cell.id = `${prefix}-c${i}`;
            if (i < count) {
                const dot = document.createElement('div');
                dot.className = `dot small ${color}`;
                dot.id = `${prefix}-d${i}`;
                cell.appendChild(dot);
            }
            el.appendChild(cell);
        }
    }

    function fillOnesFrameBorrowed(el, onesCount, color, prefix) {
        el.innerHTML = '';
        for (let i = 0; i < ONES_CELL_COUNT; i++) {
            const cell = document.createElement('div');
            cell.className = 'ones-cell';
            cell.id = `${prefix}-c${i}`;
            const inOnes = i < onesCount;
            const inBorrow = i >= 10 && i < 20;
            if (inOnes || inBorrow) {
                const dot = document.createElement('div');
                dot.className = `dot small ${color}`;
                dot.id = `${prefix}-d${i}`;
                cell.appendChild(dot);
            }
            el.appendChild(cell);
        }
    }

    function checkAnswer() {
        const val = parseInt(inputEl.value, 10);
        if (Number.isNaN(val)) return;

        if (val === state.ans) {
            inputEl.classList.add('correct');
            setMessage('ğŸ‰ å¤ªæ£’äº†ï¼ç­”å¯¹äº†ï¼', '#27ae60');
            playSound('correct');
        } else {
            inputEl.classList.add('wrong');
            setMessage('ğŸ¤” å¥½åƒä¸å¤ªå¯¹ï¼Œç‚¹â€œæ¼”ç¤ºâ€çœ‹çœ‹ï¼Ÿ', '#e74c3c');
            playSound('wrong');
            inputEl.value = '';
            setTimeout(() => inputEl.classList.remove('wrong'), 500);
        }
    }

    function showVisualHint() {
        if (state.isAnimating) return;
        state.isAnimating = true;

        if (state.mode === 'mul' || state.mode === 'div') {
            renderArray(false);
        } else {
            renderCurrent();
        }

        if (state.mode === 'add') animateAddWithin20();
        if (state.mode === 'sub') animateSubWithin20();
        if (state.mode === 'add-adv') animateAdvAdd();
        if (state.mode === 'sub-adv') animateAdvSub();
        if (state.mode === 'mul') animateMul();
        if (state.mode === 'div') animateDiv();
    }

    function animateAddWithin20() {
        const needed = 10 - state.n1;
        if (state.n2 < needed) {
            setMessage('ä¸éœ€è¦å‡‘åï¼Œç›´æ¥æ•°æ•°å“¦');
            state.isAnimating = false;
            return;
        }

        setMessage(`æŠŠ ${needed} ä¸ªçº¢ç‚¹ç§»è¿‡å»å‡‘æˆ 10ï¼`);
        for (let i = 0; i < needed; i++) {
            const dot = document.getElementById(`frame2-d${i}`);
            const targetCell = document.getElementById(`frame1-c${state.n1 + i}`);
            if (dot && targetCell) moveElement(dot, targetCell, i * 200);
        }
        const endDelay = needed * 200 + 500;
        setTimeout(() => {
            setMessage('å‡‘æˆ10åï¼Œå†æ•°ä¸€æ•°ä¸€å…±æœ‰å¤šå°‘');
            state.isAnimating = false;
        }, endDelay);
    }

    function animateSubWithin20() {
        const ones = state.n1 % 10;
        const needsBorrow = state.n1 > 9 && ones < state.n2;

        if (!needsBorrow) {
            setMessage(`æ‹¿èµ° ${state.n2} ä¸ªç‚¹...`);
            const dots = collectDots('frame2', 9).concat(collectDots('frame1', 9));
            const delay = fadeDots(dots, state.n2, 0, 260);
            setTimeout(() => {
                setMessage('å†æ•°ä¸€æ•°è¿˜å‰©å¤šå°‘');
                state.isAnimating = false;
            }, delay + 200);
            return;
        }

        setMessage('ä¸ªä½ä¸å¤Ÿï¼Œå€Ÿ1ä¸ªåï¼Œå˜æˆ10ä¸ªç‚¹');
        frame1El.classList.add('frame-glow');
        const moveCount = 10 - ones;
        for (let i = 0; i < moveCount; i++) {
            const dot = document.getElementById(`frame1-d${9 - i}`);
            const targetCell = document.getElementById(`frame2-c${ones + i}`);
            if (dot && targetCell) moveElement(dot, targetCell, i * 180);
        }

        const borrowDelay = moveCount * 180 + 400;
        setTimeout(() => {
            frame1El.classList.remove('frame-glow');
            fillGrid('frame1', ones, 'blue');
            fillGrid('frame2', 10, 'blue');
            setMessage(`å€Ÿåˆ°10ä¸ªç‚¹ï¼Œç°åœ¨æ‹¿èµ° ${state.n2} ä¸ª`);
            const dots = collectDots('frame2', 9);
            const delay = fadeDots(dots, state.n2, 0, 260);
            setTimeout(() => {
                setMessage('å†æ•°ä¸€æ•°è¿˜å‰©å¤šå°‘');
                state.isAnimating = false;
            }, delay + 200);
        }, borrowDelay);
    }

    function animateAdvAdd() {
        const ones1 = state.n1 % 10;
        const ones2 = state.n2 % 10;
        const sum = ones1 + ones2;

        if (sum < 10) {
            setMessage(`ä¸ªä½å¤ŸåŠ ï¼Œå…ˆç®— ${ones1} + ${ones2}`);
            pulseDots('ones1', ones1);
            pulseDots('ones2', ones2);
            setTimeout(() => {
                setMessage('å†å’Œåä½ä¸€èµ·æ•°ä¸€æ•°');
                state.isAnimating = false;
            }, 700);
            return;
        }

        const needed = 10 - ones1;
        setMessage(`ä»å³è¾¹æ‹¿ ${needed} ä¸ªï¼Œå‡‘æˆ10`);
        for (let i = 0; i < needed; i++) {
            const dot = document.getElementById(`ones2-d${i}`);
            const targetCell = document.getElementById(`ones1-c${ones1 + i}`);
            if (dot && targetCell) moveElement(dot, targetCell, i * 180);
        }

        const moveDelay = needed * 180 + 900;
        setTimeout(() => {
            const leftover = ones2 - needed;
            fillOnesFrame(ones1El, 10, 'blue', 'ones1');
            fillOnesFrame(ones2El, leftover, 'red', 'ones2');
            setMessage('çœ‹ï¼Œå·¦è¾¹å‡‘æˆäº†ä¸€ç»„10ä¸ªç‚¹');
            pulseDotsRange('ones1', 0, 9);
            setTimeout(() => {
                setMessage('è¿™10ä¸ªç‚¹å¯ä»¥æ¢æˆ1æ ¹åæ£’');
                const dots = collectDotsRange('ones1', 0, 9);
                const fadeDelay = fadeDots(dots, 10, 0, 80);
                setTimeout(() => {
                    const tens1 = Math.floor(state.n1 / 10);
                    fillTensRack(tens1El, tens1 + 1, 'blue');
                    const newRod = tens1El.lastElementChild;
                    if (newRod) newRod.classList.add('pop');
                    fillOnesFrame(ones1El, 0, 'blue', 'ones1');
                    fillOnesFrame(ones2El, leftover, 'red', 'ones2');
                    fillTensRack(tens2El, 0, 'red');

                    if (leftover > 0) {
                        setMessage('æŠŠå³è¾¹å‰©ä¸‹çš„ç‚¹æ¬è¿‡æ¥');
                        for (let i = 0; i < leftover; i++) {
                            const dot = document.getElementById(`ones2-d${i}`);
                            const targetCell = document.getElementById(`ones1-c${i}`);
                            if (dot && targetCell) moveElement(dot, targetCell, i * 160);
                        }
                        const moveLeftDelay = leftover * 160 + 900;
                        setTimeout(() => {
                            fillOnesFrame(ones1El, leftover, 'blue', 'ones1');
                            fillOnesFrame(ones2El, 0, 'red', 'ones2');
                            setMessage('å†æŠŠå‰©ä¸‹çš„ç‚¹å’Œåä½ä¸€èµ·æ•°æ•°');
                            state.isAnimating = false;
                        }, moveLeftDelay);
                    } else {
                        setMessage('å†æŠŠåä½ä¸€èµ·æ•°æ•°');
                        state.isAnimating = false;
                    }
                }, fadeDelay + 200);
            }, 900);
        }, moveDelay);
    }

    function animateAdvSub() {
        const ones1 = state.n1 % 10;
        const ones2 = state.n2 % 10;

        if (ones1 >= ones2) {
            setMessage(`ä¸ªä½å¤Ÿå‡ï¼Œå…ˆå‡ ${ones2}`);
            const dots = collectDots('ones1', ONES_CELL_COUNT - 1);
            const delay = fadeDots(dots, ones2, 0, 240);
            setTimeout(() => {
                setMessage('å†æ•°ä¸€æ•°è¿˜å‰©å¤šå°‘');
                state.isAnimating = false;
            }, delay + 200);
            return;
        }

        setMessage('ä¸ªä½ä¸å¤Ÿï¼Œå€Ÿ1æ ¹åæ£’');
        const tens1 = Math.floor(state.n1 / 10);
        const borrowRod = tens1El.lastElementChild;
        const borrowDelay = borrowRod ? animateBorrowDots(borrowRod, 'ones1', 10, 10, 120) : 400;
        setTimeout(() => {
            fillTensRack(tens1El, tens1 - 1, 'blue');
            fillOnesFrameBorrowed(ones1El, ones1, 'blue', 'ones1');
            setMessage(`å€Ÿåˆ°10ä¸ªç‚¹ï¼Œä»è¿™é‡Œæ‹¿èµ° ${ones2} ä¸ª`);
            const dots = collectDotsRange('ones1', 10, 19);
            const delay = fadeDots(dots, ones2, 0, 240);
            setTimeout(() => {
                setMessage('å†æ•°ä¸€æ•°è¿˜å‰©å¤šå°‘');
                state.isAnimating = false;
            }, delay + 200);
        }, borrowDelay);
    }

    function animateMul() {
        const rows = document.querySelectorAll('.array-row');
        setMessage(`${state.n1} è¡Œï¼Œæ¯è¡Œ ${state.n2} ä¸ª`);
        rows.forEach((row, idx) => {
            setTimeout(() => row.classList.add('show'), idx * 240);
        });
        const delay = rows.length * 240 + 400;
        setTimeout(() => {
            setMessage('æ•°æ•°çœ‹ä¸€å…±æœ‰å¤šå°‘');
            state.isAnimating = false;
        }, delay);
    }

    function animateDiv() {
        const rows = document.querySelectorAll('.array-row');
        setMessage(`æŠŠ ${state.n1} å¹³å‡åˆ†æˆæ¯ç»„ ${state.n2} ä¸ª`);
        rows.forEach((row, idx) => {
            setTimeout(() => row.classList.add('show'), idx * 240);
        });
        const delay = rows.length * 240 + 400;
        setTimeout(() => {
            setMessage('çœ‹çœ‹èƒ½åˆ†æˆå‡ ç»„');
            state.isAnimating = false;
        }, delay);
    }

    function collectDots(prefix, maxIndex) {
        const dots = [];
        for (let i = maxIndex; i >= 0; i--) {
            const dot = document.getElementById(`${prefix}-d${i}`);
            if (dot) dots.push(dot);
        }
        return dots;
    }

    function collectDotsRange(prefix, startIndex, endIndex) {
        const dots = [];
        for (let i = endIndex; i >= startIndex; i--) {
            const dot = document.getElementById(`${prefix}-d${i}`);
            if (dot) dots.push(dot);
        }
        return dots;
    }

    function fadeDots(dots, count, startDelay, interval) {
        const limit = Math.min(count, dots.length);
        for (let i = 0; i < limit; i++) {
            setTimeout(() => {
                dots[i].classList.add('faded');
                playSound('wrong');
            }, startDelay + i * interval);
        }
        return startDelay + limit * interval;
    }

    function pulseDots(prefix, count) {
        for (let i = 0; i < count; i++) {
            const dot = document.getElementById(`${prefix}-d${i}`);
            if (!dot) continue;
            dot.classList.add('pulse');
            setTimeout(() => dot.classList.remove('pulse'), 600);
        }
    }

    function pulseDotsRange(prefix, startIndex, endIndex) {
        for (let i = startIndex; i <= endIndex; i++) {
            const dot = document.getElementById(`${prefix}-d${i}`);
            if (!dot) continue;
            dot.classList.add('pulse');
            setTimeout(() => dot.classList.remove('pulse'), 600);
        }
    }

    function animateBorrowDots(startEl, targetPrefix, startIndex, count, delayStep) {
        const startRect = startEl.getBoundingClientRect();
        const startX = startRect.left + startRect.width / 2;
        const startY = startRect.top + startRect.height / 2;
        const tempDots = [];

        for (let i = 0; i < count; i++) {
            const dot = document.createElement('div');
            dot.className = 'dot small blue';
            dot.style.position = 'fixed';
            dot.style.left = `${startX - 6}px`;
            dot.style.top = `${startY - 6}px`;
            dot.style.zIndex = 999;
            dot.style.pointerEvents = 'none';
            document.body.appendChild(dot);
            const targetCell = document.getElementById(`${targetPrefix}-c${startIndex + i}`);
            if (targetCell) moveElement(dot, targetCell, i * delayStep);
            tempDots.push(dot);
        }

        const totalDelay = count * delayStep + 700;
        setTimeout(() => {
            tempDots.forEach((dot) => dot.remove());
        }, totalDelay);
        return totalDelay;
    }

    function moveElement(el, targetParent, delay) {
        setTimeout(() => {
            const start = el.getBoundingClientRect();
            const end = targetParent.getBoundingClientRect();
            const dx = (end.left + end.width / 2) - (start.left + start.width / 2);
            const dy = (end.top + end.height / 2) - (start.top + start.height / 2);
            el.style.transform = `translate(${dx}px, ${dy}px)`;
        }, delay);
    }

    function resetUI() {
        inputEl.value = '';
        inputEl.classList.remove('correct', 'wrong');
        setMessage('å‡†å¤‡å¥½äº†å—ï¼Ÿ');
        [frame1El, frame2El, ones1El, ones2El, tens1El, tens2El].forEach((el) => {
            if (el) el.classList.remove('frame-glow');
        });
    }

    function setInputValue(value) {
        inputEl.value = value;
        inputEl.classList.remove('correct', 'wrong');
    }

    function getMaxInputLength() {
        return Math.max(2, String(state.ans).length);
    }

    function handleKeypadInput(key) {
        if (key === 'submit') {
            checkAnswer();
            return;
        }
        if (key === 'clear') {
            setInputValue('');
            return;
        }
        if (key === 'back') {
            setInputValue(inputEl.value.slice(0, -1));
            return;
        }
        if (!/^\d$/.test(key)) return;

        let current = inputEl.value;
        if (current.length >= getMaxInputLength()) return;
        if (current === '0') current = '';
        setInputValue(current + key);
    }

    function rand(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    document.querySelectorAll('.mode-btn').forEach((btn) => {
        btn.addEventListener('click', () => setMode(btn.dataset.mode));
    });
    hintBtn.addEventListener('click', showVisualHint);
    nextBtn.addEventListener('click', generateProblem);
    keypadEl.addEventListener('click', (e) => {
        const key = e.target.dataset.key;
        if (key) handleKeypadInput(key);
    });

    document.addEventListener('keydown', (e) => {
        if (e.key >= '0' && e.key <= '9') handleKeypadInput(e.key);
        if (e.key === 'Backspace') handleKeypadInput('back');
        if (e.key === 'Enter') handleKeypadInput('submit');
    });

    generateProblem();
</script>
</body>
</html>
