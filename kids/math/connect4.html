<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½å››å­æ£‹</title>
    <style>
        :root {
            --bg-p1: #FFEBEE;
            --bg-p2: #FFFDE7;
            --board-color: #2980b9;
            --board-dark: #1f618d;
            --p1-color: #e74c3c;
            --p2-color: #f1c40f;
            --cell-size: min(13.5vw, 65px);
            --gap: min(1.2vw, 6px);
        }

        body {
            font-family: 'Segoe UI', 'Rounded Mplus 1c', sans-serif;
            background-color: var(--bg-p1);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: none;
            user-select: none;
            transition: background-color 0.5s;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            width: 100%;
            height: 50px;
            padding: 0 15px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: grid;
            grid-template-columns: 80px auto 60px;
            align-items: center;
            z-index: 100;
            flex-shrink: 0;
        }

        .btn-back {
            text-decoration: none;
            color: #666;
            font-weight: bold;
            background: #f5f5f5;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            justify-self: start;
            display: flex;
            align-items: center;
            gap: 2px;
            white-space: nowrap;
        }

        .status-card {
            background: white;
            padding: 4px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 800;
            font-size: 1rem;
            color: #333;
            border: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .status-card.p1 { border-color: var(--p1-color); color: var(--p1-color); }
        .status-card.p2 { border-color: var(--p2-color); color: #d35400; }

        .avatar { font-size: 1.2rem; }

        .scoreboard-btn {
            justify-self: end;
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        .game-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 10px;
        }

        .board-frame {
            background-color: var(--board-color);
            padding: 10px 10px 20px 10px;
            border-radius: 12px 12px 6px 6px;
            box-shadow: 0 5px 0 var(--board-dark), 0 15px 25px rgba(0,0,0,0.2);
            position: relative;
            border-top: 8px solid #3498db;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(7, var(--cell-size));
            grid-template-rows: repeat(6, var(--cell-size));
            gap: var(--gap);
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            border-radius: 50%;
            background-color: #1a5276; 
            box-shadow: inset 2px 2px 6px rgba(0,0,0,0.4);
            position: relative;
            cursor: pointer;
        }

        /* é¢„åˆ¤è½å­ (ä»…åœ¨äººç±»å›åˆæ˜¾ç¤º) */
        body:not(.game-over):not(.ai-thinking).p1-active .cell:empty:hover::after {
            content: ''; position: absolute; top: 15%; left: 15%; width: 70%; height: 70%;
            border-radius: 50%; background: var(--p1-color); opacity: 0.4;
        }
        body:not(.game-over):not(.ai-thinking).p2-active .cell:empty:hover::after {
            content: ''; position: absolute; top: 15%; left: 15%; width: 70%; height: 70%;
            border-radius: 50%; background: var(--p2-color); opacity: 0.4;
        }

        /* æ£‹å­ */
        .piece {
            width: 100%; height: 100%; border-radius: 50%;
            position: absolute; top: 0; left: 0; z-index: 5;
            animation: popIn 0.2s ease-out;
            box-shadow: inset -2px -2px 4px rgba(0,0,0,0.2), 1px 1px 3px rgba(0,0,0,0.3);
        }

        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .piece.p1 { background: radial-gradient(circle at 35% 35%, #ff7675, var(--p1-color)); }
        .piece.p2 { background: radial-gradient(circle at 35% 35%, #ffeaa7, var(--p2-color)); }

        .piece.winner {
            animation: winPulse 0.8s infinite alternate;
            filter: brightness(1.2);
            box-shadow: 0 0 15px white;
        }
        @keyframes winPulse { from { transform: scale(0.95); } to { transform: scale(1.05); } }

        .controls { 
            margin-bottom: 20px; 
            margin-top: -10px; 
            flex-shrink: 0;
        }
        
        .btn-restart {
            background: #2ECC71;
            color: white;
            border: none;
            padding: 10px 35px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 3px 0 #27ae60;
            cursor: pointer;
        }
        .btn-restart:active { transform: translateY(3px); box-shadow: 0 0 0; }

        /* å¼¹çª— */
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }

        .modal {
            background: white; padding: 20px; border-radius: 16px;
            text-align: center; width: 85%; max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .mode-btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .team-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; padding: 12px;
            border: 2px solid #eee; border-radius: 12px;
            background: white; font-size: 1.1rem; font-weight: bold; cursor: pointer;
            transition: background 0.2s;
        }
        .team-btn:active { background: #f9f9f9; }
        .team-btn.pvp { color: #333; border-color: #333; }
        .team-btn.pve { color: #2980b9; border-color: #2980b9; }

        .rank-row {
            display: flex; justify-content: space-between; padding: 8px;
            border-bottom: 1px solid #eee; font-size: 1rem;
        }
        .rank-score { font-weight: bold; }

    </style>
</head>
<body>

<!-- æ¨¡å¼é€‰æ‹©å¼¹çª— -->
<div class="overlay active" id="startModal">
    <div class="modal">
        <h3 style="margin:0 0 5px 0">æ¬¢è¿æ¥åˆ°æ™ºèƒ½å››å­æ£‹</h3>
        <p style="color:#666; font-size:0.9rem; margin:0">è‡ªç”±è½å­è§„åˆ™</p>
        <div class="mode-btn-group">
            <button class="team-btn pvp" onclick="selectMode('pvp')">
                <span class="avatar">ğŸ‘¥</span> åŒäººå¯¹æˆ˜
            </button>
            <button class="team-btn pve" onclick="selectMode('pve')">
                <span class="avatar">ğŸ¤–</span> æŒ‘æˆ˜æœºå™¨äºº
            </button>
        </div>
    </div>
</div>

<!-- æ’è¡Œæ¦œå¼¹çª— -->
<div class="overlay" id="rankModal">
    <div class="modal">
        <h3 style="margin-top:0">ğŸ† èƒœåˆ©æ¦œ</h3>
        <div class="rank-row">
            <span>ğŸ¯ çº¢æ–¹èƒœ</span>
            <span class="rank-score" id="scoreP1">0</span>
        </div>
        <div class="rank-row">
            <span>ğŸ¼ é»„æ–¹/AIèƒœ</span>
            <span class="rank-score" id="scoreP2">0</span>
        </div>
        <button class="btn-restart" style="margin-top:15px; font-size:0.9rem; padding:8px 20px;" onclick="closeRank()">å…³é—­</button>
    </div>
</div>

<header>
    <a href="index.html" class="btn-back">ğŸ”™ è¿”å›</a>
    <div class="status-card" id="statusCard">
        <span class="avatar" id="turnAvatar">ğŸ¯</span>
        <span id="statusText">çº¢æ–¹å›åˆ</span>
    </div>
    <button class="scoreboard-btn" onclick="showRank()">ğŸ†</button>
</header>

<div class="game-wrapper">
    <div class="board-frame">
        <div class="board" id="board">
            <!-- Grid Cells -->
        </div>
    </div>
</div>

<div class="controls">
    <button class="btn-restart" onclick="showStartScreen()">ğŸ”„ é‡æ–°å¼€å§‹</button>
</div>

<script>
    const ROWS = 6;
    const COLS = 7;
    let boardState = [];
    let currentPlayer = 1; // 1: Red (Human), 2: Yellow (Human/AI)
    let isGameOver = false;
    let gameMode = 'pvp'; // 'pvp' or 'pve'
    let isAiThinking = false;
    
    // è®°å½•èƒœåˆ©æ¬¡æ•°
    let wins = { 1: 0, 2: 0 };
    if(localStorage.getItem('c4_wins_p1')) wins[1] = parseInt(localStorage.getItem('c4_wins_p1'));
    if(localStorage.getItem('c4_wins_p2')) wins[2] = parseInt(localStorage.getItem('c4_wins_p2'));

    const boardEl = document.getElementById('board');
    const statusText = document.getElementById('statusText');
    const statusCard = document.getElementById('statusCard');
    const turnAvatar = document.getElementById('turnAvatar');
    const bodyEl = document.body;
    
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playClickSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.setValueAtTime(600, t);
        osc.frequency.exponentialRampToValueAtTime(300, t + 0.1);
        gain.gain.setValueAtTime(0.3, t);
        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
        osc.start();
        osc.stop(t + 0.1);
    }

    function playWinSound() {
        new Audio('amazing.mp3').play().catch(()=>{});
    }

    function showStartScreen() {
        document.getElementById('startModal').classList.add('active');
    }

    function selectMode(mode) {
        gameMode = mode;
        initGame();
        document.getElementById('startModal').classList.remove('active');
    }

    function initGame() {
        boardState = Array(ROWS).fill().map(() => Array(COLS).fill(0));
        currentPlayer = 1;
        isGameOver = false;
        isAiThinking = false;
        
        bodyEl.classList.remove('game-over');
        bodyEl.classList.remove('ai-thinking');
        renderBoard();
        updateUI();
    }

    function updateUI() {
        // P1å§‹ç»ˆæ˜¯çº¢æ–¹ï¼ŒP2æ˜¯é»„æ–¹
        if(currentPlayer === 1) {
            bodyEl.style.backgroundColor = 'var(--bg-p1)';
            bodyEl.classList.remove('p2-active');
            bodyEl.classList.add('p1-active');
            statusCard.className = 'status-card p1';
            turnAvatar.textContent = 'ğŸ¯';
            statusText.textContent = isGameOver ? "çº¢æ–¹è·èƒœï¼" : "çº¢æ–¹å›åˆ";
        } else {
            bodyEl.style.backgroundColor = 'var(--bg-p2)';
            bodyEl.classList.remove('p1-active');
            bodyEl.classList.add('p2-active');
            statusCard.className = 'status-card p2';
            turnAvatar.textContent = (gameMode === 'pve') ? 'ğŸ¤–' : 'ğŸ¼';
            
            if (isGameOver) {
                statusText.textContent = (gameMode === 'pve') ? "æœºå™¨äººè·èƒœï¼" : "é»„æ–¹è·èƒœï¼";
            } else {
                statusText.textContent = (gameMode === 'pve') ? "æœºå™¨äººæ€è€ƒ..." : "é»„æ–¹å›åˆ";
            }
        }
        
        if(isGameOver) bodyEl.classList.add('game-over');
    }

    function renderBoard() {
        boardEl.innerHTML = '';
        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.onclick = () => handleMove(r, c, cell);
                
                if (boardState[r][c] !== 0) {
                    const piece = document.createElement('div');
                    piece.className = `piece p${boardState[r][c]}`;
                    cell.appendChild(piece);
                }
                boardEl.appendChild(cell);
            }
        }
    }

    function handleMove(r, c, cellEl) {
        // æ¸¸æˆç»“æŸï¼Œæˆ–ä½ç½®æœ‰å­ï¼Œæˆ–æ­£åœ¨AIæ€è€ƒï¼Œéƒ½ä¸èƒ½è½å­
        if (isGameOver || boardState[r][c] !== 0 || isAiThinking) return;

        // æ‰§è¡Œè½å­
        placePiece(r, c, currentPlayer, cellEl);

        // æ£€æŸ¥ç»“æœ
        if (checkGameStatus(r, c)) return;

        // åˆ‡æ¢å›åˆ
        currentPlayer = currentPlayer === 1 ? 2 : 1;
        updateUI();

        // å¦‚æœæ˜¯ PVE ä¸”è½®åˆ° P2ï¼Œè§¦å‘ AI
        if (gameMode === 'pve' && currentPlayer === 2) {
            isAiThinking = true;
            bodyEl.classList.add('ai-thinking');
            setTimeout(makeAiMove, 600); // å»¶è¿Ÿæ¨¡æ‹Ÿæ€è€ƒ
        }
    }

    function placePiece(r, c, p, cellEl) {
        boardState[r][c] = p;
        
        // å¦‚æœæ²¡æœ‰ä¼ cellEl (AIä¸‹æ£‹)ï¼Œéœ€è¦å»æŸ¥æ‰¾
        if (!cellEl) {
            const idx = r * COLS + c;
            cellEl = boardEl.children[idx];
        }

        const piece = document.createElement('div');
        piece.className = `piece p${p}`;
        cellEl.appendChild(piece);
        
        playClickSound();
    }

    function checkGameStatus(r, c) {
        const winPath = checkWin(r, c, currentPlayer);
        if (winPath) {
            isGameOver = true;
            playWinSound();
            updateUI();
            
            wins[currentPlayer]++;
            localStorage.setItem('c4_wins_p1', wins[1]);
            localStorage.setItem('c4_wins_p2', wins[2]);
            
            winPath.forEach(pos => {
                const idx = pos.r * COLS + pos.c;
                const targetCell = boardEl.children[idx];
                const p = targetCell.querySelector('.piece');
                if(p) p.classList.add('winner');
            });
            return true;
        }
        
        // æ£€æŸ¥å¹³å±€
        const isFull = boardState.every(row => row.every(cell => cell !== 0));
        if (isFull) {
            isGameOver = true;
            statusText.textContent = "å¹³å±€ï¼ğŸ¤";
            return true;
        }
        return false;
    }

    // --- AI é€»è¾‘ ---
    function makeAiMove() {
        if(isGameOver) return;

        // 1. å°è¯•å¯»æ‰¾è‡´èƒœä¸€æ­¥
        let move = findWinningMove(2); // AIæ˜¯2
        if (!move) {
            // 2. å°è¯•å¯»æ‰¾é˜»æŒ¡å¯¹æ‰‹è‡´èƒœçš„ä¸€æ­¥
            move = findWinningMove(1); // å¯¹æ‰‹æ˜¯1
        }
        if (!move) {
            // 3. å¯»æ‰¾è¿æˆ3å­çš„ä¸€æ­¥ï¼Œæˆ–éšæœº
            move = findSmartMove();
        }

        // æ‰§è¡Œ AI ç§»åŠ¨
        placePiece(move.r, move.c, 2);
        
        if (!checkGameStatus(move.r, move.c)) {
            currentPlayer = 1;
            isAiThinking = false;
            bodyEl.classList.remove('ai-thinking');
            updateUI();
        }
    }

    function findWinningMove(player) {
        // éå†æ‰€æœ‰ç©ºä½ï¼Œçœ‹ä¸‹äº†ä¹‹åæ˜¯å¦ä¼šèµ¢
        for(let r=0; r<ROWS; r++) {
            for(let c=0; c<COLS; c++) {
                if(boardState[r][c] === 0) {
                    // æ¨¡æ‹Ÿè½å­
                    boardState[r][c] = player;
                    const win = checkWin(r, c, player);
                    boardState[r][c] = 0; // å›æº¯
                    
                    if(win) return {r, c};
                }
            }
        }
        return null;
    }

    function findSmartMove() {
        // ç®€å•çš„å¯å‘å¼ï¼šä¼˜å…ˆä¸­é—´ï¼Œä¼˜å…ˆå·²æœ‰é‚»å±…
        // æ”¶é›†æ‰€æœ‰åˆæ³•ç©ºä½
        let candidates = [];
        for(let r=0; r<ROWS; r++) {
            for(let c=0; c<COLS; c++) {
                if(boardState[r][c] === 0) {
                    let score = 0;
                    // é è¿‘ä¸­å¿ƒåŠ åˆ†
                    const centerDist = Math.abs(c - 3) + Math.abs(r - 2.5);
                    score -= centerDist; 
                    
                    // æ£€æŸ¥å‘¨å›´æœ‰æ²¡æœ‰è‡ªå·±çš„å­ (å€¾å‘äºæ‰å †)
                    // ... ç®€å•èµ·è§ï¼Œä¸»è¦é éšæœºæ€§å¢åŠ è¶£å‘³ï¼Œä¸è¦å¤ªå¼º
                    candidates.push({r, c, score});
                }
            }
        }
        
        // æ’åºå¹¶æ·»åŠ éšæœºæ€§ (å–å‰5ä¸ªæœ€å¥½çš„éšæœºä¸€ä¸ª)
        candidates.sort((a, b) => b.score - a.score);
        const topN = candidates.slice(0, 5);
        return topN[Math.floor(Math.random() * topN.length)];
    }

    // æ£€æŸ¥æŸç‚¹æ˜¯å¦è¿æˆ4å­
    function checkWin(r, c, player) {
        // æ­¤æ—¶ boardState[r][c] å·²ç»æ˜¯ player (æˆ–è€…åœ¨findWinningMoveä¸­è¢«ä¸´æ—¶è®¾ç½®äº†)
        // const p = boardState[r][c]; // è¿™ä¸€è¡Œåœ¨å›æº¯æ£€æŸ¥æ—¶ä¼šå‡ºé”™ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ å…¥äº† player
        const p = player;
        const dirs = [[0,1], [1,0], [1,1], [1,-1]];
        
        for (let [dr, dc] of dirs) {
            let path = [{r,c}];
            
            let i=1; 
            while(true) {
                let nr=r+dr*i, nc=c+dc*i;
                if(nr<0||nr>=ROWS||nc<0||nc>=COLS||boardState[nr][nc]!==p) break;
                path.push({r:nr, c:nc});
                i++;
            }
            i=1;
            while(true) {
                let nr=r-dr*i, nc=c-dc*i;
                if(nr<0||nr>=ROWS||nc<0||nc>=COLS||boardState[nr][nc]!==p) break;
                path.push({r:nr, c:nc});
                i++;
            }
            
            if(path.length >= 4) return path;
        }
        return null;
    }

    function showRank() {
        document.getElementById('scoreP1').textContent = wins[1];
        document.getElementById('scoreP2').textContent = wins[2];
        document.getElementById('rankModal').classList.add('active');
    }
    
    function closeRank() {
        document.getElementById('rankModal').classList.remove('active');
    }
</script>
</body>
</html>